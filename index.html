<!DOCTYPE html>
    <html lang="he">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AI Chatbot</title>
        <style>
            body {
                font-family: 'Segoe UI', 'Roboto', sans-serif;
                background: linear-gradient(135deg, #0f0a1e, #2a0b38);
                color: #e0e0e0;
                margin: 0;
                padding: 0;
                direction: rtl;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
            }
           .hidden {
                display: none!important;
            }
            /* --- Auth Container Styles --- */
           .auth-container {
                width: 90%;
                max-width: 400px;
                background: rgba(40, 40, 40, 0.7);
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(10px);
                border: 1px solid #3d3d3d;
                transition: all 0.5s ease;
            }
           .auth-container h2 {
                text-align: center;
                color: #00f0ff;
                margin-bottom: 25px;
                font-size: 2rem;
                transition: all 0.5s ease;
            }
           .auth-container form {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
           .auth-container form input {
                width: 100%;
                box-sizing: border-box;
                padding: 15px;
                border-radius: 10px;
                border: 1px solid #00f0ff;
                background: #1a1a1a;
                color: #e0e0e0;
                font-size: 1rem;
                transition: all 0.3s ease;
            }
           .auth-container form input:focus {
                outline: none;
                border-color: #00ffff;
                box-shadow: 0 0 10px rgba(0, 240, 255, 0.5);
            }
           .auth-container form button {
                width: 100%;
                background: #00f0ff;
                color: #1a1a1a;
                border: none;
                border-radius: 10px;
                padding: 15px;
                font-size: 1.2rem;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
                letter-spacing: 1px;
            }
           .auth-container form button:hover {
                background: #00ffff;
                box-shadow: 0 0 15px rgba(0, 240, 255, 0.8);
            }
           .auth-switch {
                text-align: center;
                margin-top: 20px;
                cursor: pointer;
                color: #00f0ff;
                text-decoration: none;
                font-size: 0.9rem;
                transition: color 0.3s ease;
            }
           .auth-switch:hover {
                color: #00ffff;
                text-decoration: underline;
            }
           .auth-error {
                color: #ff4d4d;
                text-align: center;
                margin-bottom: 15px;
                font-size: 0.9rem;
                visibility: hidden;
                height: 0;
                overflow: hidden;
                transition: all 0.3s ease-in-out;
            }
           .auth-error.visible {
                visibility: visible;
                height: auto;
                margin-bottom: 15px;
            }
           .auth-error.success {
                color: #4CAF50; /* Green color for success messages */
            }
            /* --- Chat Container Styles --- */
           .chat-container {
                width: 90%;
                max-width: 800px;
                background: rgba(40, 40, 40, 0.7);
                border-radius: 15px;
                box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(10px);
                border: 1px solid #3d3d3d;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                height: 90vh;
            }
           .chat-header {
                padding: 15px;
                background: rgba(30, 30, 30, 0.8);
                border-bottom: 1px solid #4a4a4a;
                text-align: center;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
           .chat-header h1 {
                margin: 0;
                font-size: 1.6rem;
                color: #00f0ff;
                text-shadow: 0 0 5px #00f0ff;
            }
            #logout-button {
                background: #ff4d4d;
                color: white;
                border: none;
                border-radius: 5px;
                padding: 5px 10px;
                cursor: pointer;
                font-size: 0.9rem;
                transition: background-color 0.3s ease;
            }
            #logout-button:hover {
                background: #e60000;
            }
            #admin-button {
                background: #00ffff;
                color: #1a1a1a;
                border: none;
                border-radius: 5px;
                padding: 5px 10px;
                cursor: pointer;
                font-size: 0.9rem;
                transition: background-color 0.3s ease;
            }
            #admin-button:hover {
                background: #00cccc;
            }
           .chat-messages {
                flex-grow: 1;
                padding: 20px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
           .message {
                max-width: 80%;
                padding: 12px 18px;
                border-radius: 20px;
                line-height: 1.5;
                animation: fadeIn 0.4s ease-out;
                word-wrap: break-word;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
           .message.user {
                background: #007bff;
                align-self: flex-end;
                color: white;
                border-bottom-right-radius: 5px;
            }
           .message.bot {
                background: #2a2a2a;
                align-self: flex-start;
                border-bottom-left-radius: 5px;
            }
           .chat-input {
                display: flex;
                padding: 15px;
                border-top: 1px solid #4a4a4a;
                background: rgba(30, 30, 30, 0.8);
            }
           .chat-input input {
                flex-grow: 1;
                padding: 15px;
                border-radius: 50px;
                border: 1px solid #00f0ff;
                background: #1a1a1a;
                color: #e0e0e0;
                font-size: 1rem;
                margin-left: 10px;
                transition: all 0.3s ease;
            }
           .chat-input input:focus {
                outline: none;
                box-shadow: 0 0 8px #00f0ff;
            }
           .chat-input input::placeholder {
                color: #777;
            }
           .chat-input button {
                background: #00f0ff;
                color: #1a1a1a;
                border: none;
                border-radius: 50px;
                padding: 0 25px;
                font-size: 1.2rem;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
            }
           .chat-input button:hover {
                box-shadow: 0 0 10px #00f0ff;
                transform: scale(1.05);
            }
           .typing-indicator {
                align-self: flex-start;
                background: #2a2a2a;
                padding: 12px 18px;
                border-radius: 20px;
                font-style: normal;
            }
           .typing-indicator span {
                animation: typing-dots 1s infinite;
                opacity: 0;
                display: inline-block;
            }
           .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
           .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
            @keyframes typing-dots {
                0%, 80%, 100% { opacity: 0; }
                40% { opacity: 1; }
            }
            #admin-panel {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 100;
            }
            .admin-content {
                background: #2a2a2a;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
                display: flex;
                flex-direction: column;
                gap: 15px;
                text-align: center;
                max-width: 400px;
                width: 90%;
            }
            #admin-password {
                width: 100%;
                box-sizing: border-box;
                padding: 10px;
                border-radius: 5px;
                border: 1px solid #00ffff;
                background: #1a1a1a;
                color: #e0e0e0;
            }
            #submit-admin-password, #close-admin-panel {
                background: #00f0ff;
                color: #1a1a1a;
                border: none;
                border-radius: 5px;
                padding: 10px;
                font-size: 1rem;
                font-weight: bold;
            }
            #close-admin-panel {
                background: #ff4d4d;
            }
            /* NEW: CSS for code blocks */
           .message code-block {
                display: block;
                background-color: #1c1c1c;
                border-radius: 8px;
                padding: 15px;
                white-space: pre-wrap;
                word-wrap: break-word;
                font-family: 'Consolas', 'Courier New', monospace;
                line-height: 1.4;
                font-size: 0.9rem;
                border: 1px solid #4a4a4a;
                margin-top: 10px;
                position: relative; /* For positioning the copy button */
            }

           .message code-block button {
                position: absolute;
                top: 5px;
                left: 5px;
                background-color: #333;
                color: #fff;
                border: none;
                border-radius: 5px;
                padding: 5px 10px;
                font-size: 0.8rem;
                cursor: pointer;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

           .message code-block:hover button {
                opacity: 1;
            }

           .message code-block pre {
                margin: 0; /* Remove default <pre> margin */
            }

            /* Custom Modal Styles */
            .modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 200;
            }

            .modal-content {
                background: #2a2a2a;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
                text-align: center;
                max-width: 400px;
                width: 90%;
                display: flex;
                flex-direction: column;
                gap: 20px;
            }

            .modal-content h3 {
                color: #00f0ff;
                margin-bottom: 10px;
            }

            .modal-content p {
                color: #e0e0e0;
                line-height: 1.6;
            }

            .modal-content button {
                background: #00f0ff;
                color: #1a1a1a;
                border: none;
                border-radius: 10px;
                padding: 12px 20px;
                font-size: 1rem;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .modal-content button:hover {
                background: #00ffff;
                box-shadow: 0 0 10px rgba(0, 240, 255, 0.8);
            }

        </style>
    </head>
    <body>

        <div class="auth-container" data-mode="login">
            <h2 id="auth-title">התחברות</h2>
            <div id="auth-error" class="auth-error hidden"></div>

            <form id="login-form">
                <input type="email" id="login-email" placeholder="אימייל" required>
                <input type="password" id="login-password" placeholder="סיסמה" required>
                <button type="submit">התחבר</button>
            </form>

            <form id="register-form" class="hidden">
                <h2>הרשמה</h2>
                <div id="register-error" class="auth-error hidden"></div>
                <input type="text" id="register-username" placeholder="בחר שם משתמש (יוצג בצ'אט)" required>
                <input type="email" id="register-email" placeholder="הכנס כתובת מייל" required>
                <input type="password" id="register-password" placeholder="בחר סיסמה" required>
                <button type="submit">הירשם</button>
            </form>

            <p class="auth-switch" onclick="toggleForms()">אין לך חשבון? הירשם</p>
        </div>

        <div class="chat-container hidden" id="chat-container">
            <div class="chat-header">
                <button id="logout-button">התנתק</button>
                <h1 id="chat-title">בוט הצ'אט שלך</h1>
                <button id="admin-button" class="hidden">ניהול</button>
            </div>
            <div class="chat-messages" id="chatMessages">
            </div>
            <div class="chat-input">
                <input type="text" id="userInput" placeholder="אני מקשיב..." onkeydown="handleKey(event)">
                <button onclick="sendMessage()">שלח</button>
            </div>
        </div>

        <div id="admin-panel" class="hidden">
            <div class="admin-content">
                <h3>פאנל ניהול</h3>
                <input type="password" id="admin-password" placeholder="הכנס סיסמה">
                <button id="submit-admin-password">אישור</button>
                <button id="close-admin-panel">סגור</button>
                <div id="admin-content-area" class="hidden">
                    <p>פאנל זה מיועד לבדיקת המשתמשים השמורים ב-localStorage.</p>
                </div>
            </div>
        </div>

        <div id="custom-modal" class="modal hidden">
            <div class="modal-content">
                <h3 id="modal-title"></h3>
                <p id="modal-message"></p>
                <button id="modal-ok-button">אישור</button>
            </div>
        </div>

        <script>
            // API Configuration
            const apiKey = "AIzaSyD7FKOYtR57Z4e4EkPEdX58xbqB0AiX0jA"; // ה-API Key שסיפקת
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            const ADMIN_PASSWORD = 'qweR2013';

            // DOM Elements
            const authContainer = document.querySelector('.auth-container');
            const chatContainer = document.getElementById('chat-container');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const loginError = document.getElementById('auth-error');
            const registerError = document.getElementById('register-error');
            const chatMessages = document.getElementById('chatMessages');
            const userInput = document.getElementById('userInput');
            const logoutButton = document.getElementById('logout-button');
            const chatTitle = document.getElementById('chat-title');
            const adminButton = document.getElementById('admin-button');
            const adminPanel = document.getElementById('admin-panel');
            const adminPasswordInput = document.getElementById('admin-password');
            const submitAdminPassword = document.getElementById('submit-admin-password');
            const closeAdminPanelButton = document.getElementById('close-admin-panel');
            const adminContentArea = document.getElementById('admin-content-area');

            // Custom Modal Elements
            const customModal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalOkButton = document.getElementById('modal-ok-button');

            // Local State
            let currentUserId = null;
            let currentUsername = null;
            let conversationHistory = [];

            // --- Custom Modal Functions ---
            function showModal(title, message) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                customModal.classList.remove('hidden');
            }

            function hideModal() {
                customModal.classList.add('hidden');
            }

            // --- Utility Functions for localStorage ---
            function getLocalUsers() {
                const users = localStorage.getItem('users');
                return users ? JSON.parse(users) : [];
            }

            function saveLocalUsers(users) {
                localStorage.setItem('users', JSON.stringify(users));
            }

            function getChatHistory(email) {
                const history = localStorage.getItem(`chat_history_${email}`);
                return history ? JSON.parse(history) : [];
            }

            function saveChatHistory(email, history) {
                localStorage.setItem(`chat_history_${email}`, JSON.stringify(history));
            }
            
            // --- UI Functions ---
            function toggleForms() {
                loginForm.classList.toggle('hidden');
                registerForm.classList.toggle('hidden');
                loginError.classList.add('hidden');
                loginError.classList.remove('visible');
                registerError.classList.add('hidden');
                registerError.classList.remove('visible');
                const authTitle = authContainer.querySelector('h2');
                const authSwitch = authContainer.querySelector('.auth-switch');
                if (registerForm.classList.contains('hidden')) {
                    authTitle.textContent = 'התחברות';
                    authSwitch.textContent = 'אין לך חשבון? הירשם';
                } else {
                    authTitle.textContent = 'הרשמה';
                    authSwitch.textContent = 'יש לך כבר חשבון? התחבר';
                }
            }

            function displayMessages() {
                chatMessages.innerHTML = '';
                conversationHistory.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message', msg.sender);
                    messageDiv.innerHTML = formatBotResponse(msg.text);
                    chatMessages.append(messageDiv);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function formatBotResponse(text) {
                const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
                if (codeBlockRegex.test(text)) {
                    return text.replace(codeBlockRegex, (match, lang, code) => {
                        return `
                            <code-block>
                                <pre><code class="language-${lang || ''}">${code.trim()}</code></pre>
                                <button onclick="copyCode(this)">העתק</button>
                            </code-block>
                        `;
                    });
                }
                return text;
            }

            function copyCode(button) {
                const codeBlock = button.parentNode.querySelector('code');
                const codeText = codeBlock.innerText;
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = codeText;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    const originalText = button.innerText;
                    button.innerText = 'הועתק!';
                    setTimeout(() => {
                        button.innerText = originalText;
                    }, 2000);
                } catch (err) {
                    showModal('שגיאת העתקה', 'העתקת הקוד נכשלה. אנא העתק ידנית.');
                } finally {
                    document.body.removeChild(tempTextArea);
                }
            }

            // --- Auth Handlers ---
            function handleRegistration(event) {
                event.preventDefault();
                const username = document.getElementById('register-username').value.trim();
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;

                registerError.classList.add('hidden');
                if (!username || !email || !password) {
                    registerError.textContent = 'אנא מלא את כל השדות.';
                    registerError.classList.remove('hidden');
                    return;
                }

                const users = getLocalUsers();
                if (users.some(u => u.email === email)) {
                    registerError.textContent = 'כתובת המייל כבר בשימוש.';
                    registerError.classList.remove('hidden');
                    return;
                }
                if (users.some(u => u.username === username)) {
                    registerError.textContent = 'שם המשתמש כבר קיים.';
                    registerError.classList.remove('hidden');
                    return;
                }

                users.push({ username, email, password });
                saveLocalUsers(users);
                
                showModal('הרשמה בוצעה בהצלחה!', 'ההרשמה בוצעה בהצלחה! אנא התחבר עם הפרטים שלך.');
                
                document.getElementById('register-username').value = '';
                document.getElementById('register-email').value = '';
                document.getElementById('register-password').value = '';

                setTimeout(toggleForms, 3000);
            }

            function handleLogin(event) {
                event.preventDefault();
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;

                loginError.classList.add('hidden');
                if (!email || !password) {
                    loginError.textContent = 'אנא מלא את כל השדות.';
                    loginError.classList.remove('hidden');
                    return;
                }

                const users = getLocalUsers();
                const user = users.find(u => u.email === email && u.password === password);

                if (user) {
                    currentUserId = user.email; // Use email as unique ID
                    currentUsername = user.username;
                    localStorage.setItem('currentUser', JSON.stringify({ id: currentUserId, username: currentUsername }));
                    initChatSession();
                } else {
                    loginError.textContent = 'אימייל או סיסמה שגויים.';
                    loginError.classList.remove('hidden');
                }
            }

            function handleLogout() {
                localStorage.removeItem('currentUser');
                currentUserId = null;
                currentUsername = null;
                initApp();
            }

            // --- Chatbot Logic ---
            async function sendMessage() {
                const userText = userInput.value.trim();
                if (userText === '') return;

                // Add user message to UI and history
                conversationHistory.push({ sender: 'user', text: userText });
                saveChatHistory(currentUserId, conversationHistory);
                displayMessages();
                userInput.value = '';

                const lowerCaseText = userText.toLowerCase();
                const creatorKeywords = ['מי ייצר אותך', 'מי בנה אותך', 'מי המפתח', 'מאיפה באת', 'מי עומד מאחוריך'];
                const isCreatorQuestion = creatorKeywords.some(keyword => lowerCaseText.includes(keyword));

                if (isCreatorQuestion) {
                    const botResponse = "פותחתי בעזרת יונתן ברקן.";
                    conversationHistory.push({ sender: 'bot', text: botResponse });
                    saveChatHistory(currentUserId, conversationHistory);
                    displayMessages();
                    return;
                }

                // Show typing indicator
                const typingIndicator = document.createElement('div');
                typingIndicator.classList.add('message', 'typing-indicator');
                typingIndicator.innerHTML = '<span>.</span><span>.</span><span>.</span>';
                chatMessages.append(typingIndicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                const chatHistoryForGemini = conversationHistory.map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.text }]
                }));

                try {
                    const payload = { contents: chatHistoryForGemini };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error.message || 'שגיאה בקבלת תשובה מהשרת.');
                    }

                    const data = await response.json();
                    const botResponseRaw = data.candidates[0].content.parts[0].text;

                    chatMessages.removeChild(typingIndicator);

                    conversationHistory.push({ sender: 'bot', text: botResponseRaw });
                    saveChatHistory(currentUserId, conversationHistory);
                    displayMessages();
                } catch (error) {
                    chatMessages.removeChild(typingIndicator);
                    const errorDiv = document.createElement('div');
                    errorDiv.classList.add('message', 'bot');
                    errorDiv.textContent = 'אירעה שגיאה: ' + error.message;
                    chatMessages.append(errorDiv);
                    showModal('שגיאה', 'אירעה שגיאה בתקשורת עם הבוט: ' + error.message);
                }
            }

            function handleKey(event) {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            }
            
            // --- Admin Panel Logic ---
            adminButton.addEventListener('click', () => {
                adminPanel.classList.remove('hidden');
                adminPasswordInput.value = '';
                adminPasswordInput.style.borderColor = '#00f0ff';
                adminContentArea.classList.add('hidden');
            });

            submitAdminPassword.addEventListener('click', () => {
                if (adminPasswordInput.value === ADMIN_PASSWORD) {
                    adminPasswordInput.style.borderColor = '#00ff00';
                    adminContentArea.classList.remove('hidden');
                    // Display list of users from localStorage
                    const users = getLocalUsers();
                    const userList = users.map(user => `<li>${user.username} (${user.email})</li>`).join('');
                    adminContentArea.innerHTML = `
                        <h3>משתמשים רשומים:</h3>
                        <ul>${userList}</ul>
                        <p>שים לב: סיסמאות אינן מוצגות מטעמי אבטחה. לא ניתן למחוק משתמשים דרך ממשק זה.</p>
                    `;
                } else {
                    adminPasswordInput.style.borderColor = '#ff4d4d';
                    showModal('שגיאת סיסמה', 'סיסמה שגויה!');
                }
            });

            closeAdminPanelButton.addEventListener('click', () => {
                adminPanel.classList.add('hidden');
                adminPasswordInput.style.borderColor = '#00f0ff';
            });
            
            // --- Initialization ---
            function initChatSession() {
                authContainer.classList.add('hidden');
                chatContainer.classList.remove('hidden');
                chatTitle.textContent = `הצ'אט של ${currentUsername}`;
                document.title = `צ'אט - ${currentUsername}`;
                conversationHistory = getChatHistory(currentUserId);
                displayMessages();
            }

            function initApp() {
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    const user = JSON.parse(storedUser);
                    currentUserId = user.id;
                    currentUsername = user.username;
                    initChatSession();
                } else {
                    currentUserId = null;
                    currentUsername = null;
                    authContainer.classList.remove('hidden');
                    chatContainer.classList.add('hidden');
                    chatMessages.innerHTML = '';
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                    loginError.classList.add('hidden');
                    registerError.classList.add('hidden');
                    authContainer.querySelector('h2').textContent = 'התחברות';
                    authContainer.querySelector('.auth-switch').textContent = 'אין לך חשבון? הירשם';
                }
            }

            // --- Event Listeners ---
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegistration);
            logoutButton.addEventListener('click', handleLogout);
            modalOkButton.addEventListener('click', hideModal);

            // Initial call to set up the app state
            initApp();
        </script>
    </body>
    </html>
